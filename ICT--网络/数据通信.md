# 数据通信

数据通信是信息从一个地方传输到另一个地方的过程，通常通过计算机网络进行。在数据通信中，信息以数字或模拟形式在网络中传递，以满足各种通信需求。以下是与数据通信相关的一些关键概念：

## 数据通信协议

数据通信协议是用于在网络中传输和接收数据的规则和约定。最常见的数据通信协议之一是TCP/IP（Transmission Control Protocol/Internet Protocol），它是互联网上的基本通信协议套件。TCP用于可靠的数据传输，而IP用于路由数据包。

其他重要的通信协议包括：

- UDP（User Datagram Protocol）：用于无连接、不可靠的数据传输，适用于一些实时应用。
- HTTP（Hypertext Transfer Protocol）：用于在Web上传输文本、图像和其他媒体资源。
- FTP（File Transfer Protocol）：用于文件传输。
- SMTP（Simple Mail Transfer Protocol）：用于电子邮件传输。

## 网络拓扑

网络拓扑是计算机网络中设备之间物理和逻辑连接的布局方式。不同的网络拓扑形式影响着网络的性能、可伸缩性和可靠性。包括：

- 星型拓扑：所有设备连接到一个中心交换机或集线器。
- 总线拓扑：所有设备都连接到一个共享的总线。
- 环形拓扑：设备按环形连接。
- 树状拓扑：多个星型拓扑连接在一起，形成层次结构。
- 网状拓扑：所有设备都连接到其他设备。

## 网络设备

### 路由器

路由器是用于将数据包从一个网络传输到另一个网络的设备。它工作在网络层（第三层）并使用IP地址来确定数据包的最终目的地。路由器是互联网的关键组件，用于连接不同的网络，允许数据在全球范围内传输。

### 交换机

交换机是用于在局域网络（LAN）内传输数据包的设备。它工作在数据链路层（第二层）并使用MAC地址来确定数据包的最终目的地。交换机通常用于连接多个计算机和其他网络设备，实现高速和可靠的内部数据传输。

## 数据链路层

数据链路层是OSI模型中的第二层，负责将数据帧从一个设备传输到另一个设备。数据链路层的主要任务包括数据帧的封装、解封和错误检测。数据链路层头部包括源MAC地址和目标MAC地址，以便设备可以确定数据帧的发送和接收方。

## MAC地址和IP地址

MAC地址（Media Access Control Address）是每个网络适配器（如网卡）的唯一<font color=red>物理地址</font>，通常以十六进制表示。它在数据链路层用于唯一标识设备。

IP地址（Internet Protocol Address）是网络设备在互联网上的<font color=red>逻辑地址</font>。它用于在网络中标识设备，并允许数据在网络上进行路由。IPv4和IPv6是两种常见的IP地址协议。

## 数据帧类型

- 广播帧：一对所有通信的数据帧，用于向网络中的所有设备广播信息。
- 单播帧：一对一发送的通信的数据帧，可以是已知单播帧或未知单播帧。
- 组播帧：一对多发送的通信的数据帧，用于将数据传递给特定组中的多个设备。

## 交换机的工作

交换机是一种网络设备，通常工作在数据链路层。它具有以下功能：

1. 根据MAC地址将数据包从一个端口转发到另一个端口。
2. 维护MAC地址表，用于将数据包准确传递到目标设备。
3. 通过学习和过滤，仅将数据包传递到目标设备，提高网络性能。
4. 支持不同VLAN（虚拟局域网）以分隔不同网络。

交换机对数据帧处理行为
   1、泛洪
        当交换机收到**<u>广播帧、未知单播帧</u>**时，会从除接收接口以外的所有接口发送出去；
   2、转发
        当交换机收到<u>已知单播帧</u>时，会根据mac地址表查表结果从特定的接口发送出去；
   3、丢弃
        当交换机收到非法数据帧时，会直接丢弃；（不完整、vlan不匹配）

## MAC地址表

> **mac地址，接口，vlan（固定为1），学习方式**

MAC地址表是交换机内部维护的表格，它存储了与每个端口关联的设备的MAC地址。MAC地址表帮助交换机决定将数据包从哪个端口发送。它可以通过动态学习或静态配置来建立。

---

## 学习方式：

### 1.动态学习

        边学习边转发；
        当交换机收到数据帧时，会将smac以及接收到该数据帧的接口学习到mac地址表中；
        特点：
       （1）会老化，默认老化时间为300s；
       （2）重启会丢失；
       （3）会被覆盖（后学习的会覆盖原有的表项）
                 mac地址漂移（震荡）：mac地址表项中的某个mac地址，出接口发生改变；
        优势：灵活
        缺陷：安全性差
        适用于流动性较高的设备；

### 2、静态学习

       由管理员手工配置
       特点：
       （1）不会老化
       （2）重启不会丢失
       （3）不会被动态学习所覆盖
       优点：安全性高；
       缺陷：不灵活，无法根据网络变化情况自动修改mac地址表；
       适用于位置固定，且对安全性要求较高的设备；

### 3、黑洞表项

       由管理员手工配置
       作用：用于过滤网络中已知的攻击者的流量；
       原理：如果交换机收到的数据帧smac或者dmac匹配到黑洞表项，均会丢弃；
       特点：与静态一致；

---

 指令：system-view

                display mac-address

                display mac-address aging-time

                mac-address aging-time 250        //modify aging-time

---

## 在拓扑的建设中，PC、交换机之间形成多种环路，出现冗余，导致环路带来问题。而STP就是这么一个协议来解决这样的环路问题

### 二层环路

  定义：交换机（二层设备）之间通过物理链路连成环状拓扑（物理成环），并且没有开启防环协议；
  危害：广播风暴（网络中存在大量广播报文）——浪费链路资源——消耗设备的开销；
            mac地址频繁漂移——流量无法互访；
  解决：开启防环协议（堆叠、生成树协议、链路聚合......）

## 生成树协议

  作用：防止环路产生；
  原理：在整个交换网络中计算一颗生成树，在交换机相连的端口中，选举出端口进行堵塞，被堵塞的端口无法收发任何的数据帧，从而实现防环；
  版本：
   STP——802.1d——慢收敛（30~50s）
   RSTP——802.1s——快收敛（秒级）
   MSTP——802.1w——多颗生成树

---

## 基本组成

1. 桥id
   
   > 每个交换机就是一个桥，它的id称为桥id

2. 根桥：
   
   > 最主要，最重要的一个桥（优先级最高）

3. Cost-开销
   
   > cost值可修改（4096的倍数）每经过一个出接口RP都会有开销

4. Root Path Cost（RPC）
   
   > 某个桥从其接口到根桥

5. BPDU
   
   > 是STP的协议报文/数据 ———>用作控制选举 
   > 
   > > 与之相对的是其他数据帧-->系统运行产生的流量

### stp工作过程

1、在整个交换网络中选举出一台交换机作为根桥（ROOT）
2、所有的非根交换机各选出一个根端口（RP）
3、在所有二层链路上各选出一个指定端口（DP）
 一般情况下，根桥的所有接口均为DP
 交换机连接PC、路由器的端口均为DP
4、剩余的端口置为非根非指定端口（AP），直接堵塞，用于防环；

### **STP选举过程**

##### 比较四要素，顺序比较，越小越优

> 选举四要素
> 
> - 根桥id
>   
>   > 指根桥的桥id-->桥id：每个交换机都有，由stp优先级+mac地址组成；
> 
> - 根路径开销（默认20000，可修改）
> 
> > BPDU发送者到根桥的开销
> 
> - 发送者桥id（优先值+mac地址）
> 
> - 发送端口id
>   
>   > BPDU的发送接口的<font color=yellow>优先级+端口编号</font>
>   > 
>   >                 接口优先级：默认为128；

## 选举详细过程

1. 网络运行之初，所有交换机都会认为自己是根桥，所有的接口均为DP；
    所有的交换机均会产生配置BPDU，其中根桥id均为自身的桥id，向外发送 相互比较根桥id，其中最优的设备会成为根桥，其余交换机成为非根交换机，并且停止发送BPDU；
    选举完根桥后，全网的BPDU的根桥id均保持一致；选举RP（根端口）出接口

2. 每台非根交换机只有一个RP
   
     <font color=yellow>RP用于接收最优BPDU</font> //第三因素判断：要看发送者，要找最近的发射者的id
   
   RP用于非根交换机以最短路径**访问**根桥
   
   选举RP比较根桥开销时，不直接比较报文数据，直接比较各候选端口，去往根桥的开销，最小的为RP；

3. 选举DP（每段二层链路有且仅有一个//二层链路，交换机之间的路） -->收接口
   
   > 根桥接口一般是DP口
   
    用于发送最优的BPDU，每段链路发送最佳BPDU的接口为最佳DP口
   
    比较根路径开销时，直接比较报文数值

4. 剩余的端口为AP（非根非指定端口）直接堵塞，用于防环

## STP接口状态

1. Discarding（堵塞）---> AP   
   
   是所有接口的初始状态；
   
   处于该状态的接口无法发送任何数据帧（不是BPDU），也无法学习mac地址表 

2. learning(学习状态)
   
   接口可以转发数据帧，也可以学习mac地址表
   
   <过渡状态>，不会有接口永久处于此状态

3. forwarding（转发状态）
   
   接口可以转发状态帧也可以学习mac地址表
   
   RP/DP最终会处于该状态

#### 转发延时：15s

discarding--15s-->learning--15s-->forwarding

反向forwarding---->discarding    没有延迟

作用：反环堵塞

//老化时间20s--------->根桥每两秒会发出根BPDU以让RP确认根桥存在。而RP20s没有收到根BPDU就会认为根桥不在了，重置/老化根桥



BPDU的收发不受端口影响，受端口角色影响；

DP--->收发配置BPDU

RP/AP---->只收<font color =yellow>配置</font>BPDU

> BPDU分为配置/TCN（拓扑变更通知）

---

> 在网络发生变化时，端口状态随之变化，此时报文传输路径可能会发生变化，而mac地址表为变化，导致指引错误。

### 拓扑变更(用到 TCN BPDU / 配置BPDU flag位中的TC和TCA)

> 目的清空交换机的mac地址表

触发条件：有接口的状态进入到forwarding----->接口所在的交换机发生 故障/错误

机制：

1. 发生拓扑变更的设备发出<font color=yellow>TCN BPDU</font>（拓扑变更通知BPDU）
   
   上游交换机发送TCA=1的配置BPDU作为回复，并将TCN BPDU继续从RP口发出（通向根桥---->目的清空mac地址表而只有根桥有权限）直到根桥收到为止

2. 根桥收到TCN BPDU后，回复TCA=1的配置BPDU，再发送TC=1的配置BPDU（确认清除mac地址表），持续35s约17次保证所有交换机都能收到。交换机收到后就会清除自身mac地址表及ARP缓存表。
   
   ---
   
   <img src="file:///Users/jolin/Pictures/md.pic.library/链路聚合例子.png" title="" alt="" width="774">
   
   

### 导语

> **在S1和S2之间连接两条链路，会形成一个环路。但我们可以将两条链路聚合---->将多条物理链路从逻辑上看作一条**

### 链路聚合/捆绑 （Eth-trunk)

##### 定义：

> 将多条物理链路从逻辑上看作一条链路
> 
> > 如图，相当于两条链路共用一个端口，<font color=green>两条链路都可以进行数据传输</font>。

##### 作用：

1. 防止环路；

2. 提升带宽；

3. 提升链路资源利用率；

#### 配置：

1. 手工负载（默认）
   
   特点：
   
   - 一旦物理接口绑定进链路聚合口，即可转发数据；
   
   - 没有活动以及非活动链路之分；       / *全都可传输数据/up* /
   
   - 只能做负载，无法实现主/备；<font color=cerise>S1和S2之间不会交互报文 </font> / *没有选择性的开启/关闭* /
   
   - n无需交互报文，节省链路资源，但是无法感知对端是否进行链路聚合的绑定，容易出现丢包；
     
     - S1开启
       
       - eth-tunk，直接可以传输数据；<font color=pink>不理会S2</font>是否开启，若S2未开启eth-tunk则出现丢包的情况。
   
   #### 配置相关代码：
   
   interface Eth-Trunk 1 //创建链路聚合口，编号为1，手工负载模式的编号两端<font color=yellow>可以不一致</font>；
   trunkport GigabitEthernet 0/0/1 0/0/3 //将G0/0/1以及G0/0/3接口绑定进Eth-Trunk 1中
   display Eth-Trunk 1 //查看Eth-Trunk 1的状态

2. LACP

 特点：有活动以及非活动链路数目之分，默认最大活动链路数目为8条；
            双方会交互报文，必须双方均绑定了相同链路，对应的链路才能参与数据转发；

      活跃链路选举规则：
       越小越优
       a、先比较端口优先级（默认为32768）
          interface GigabitEthernet0/0/2
            lacp priority 40000         //修改端口LACP优先级
       b、比较端口编号
    
      主动端选举
       主动端：作为链路聚合中的控制器，当两端所配置的活跃链路不一致时，以主动端的为准；
       选举规则：越小越优
       a、先比较全局LACP优先级（系统优先级），默认32768；
          [S1]lacp priority 100         //修改LACP全局优先级为100
       b、比较mac地址；
    
    
      配置：
      interface Eth-Trunk 1          //创建链路聚合口，编号为1，LACP模式下，编号需要一致；
       mode lacp-static              //修改模式为lacp
       trunkport GigabitEthernet 0/0/1 0/0/3
       max active-linknumber 2       //修改最大活跃链路数目为2，实现主备
       lacp preempt enable           //开启抢占，默认不开启
       lacp preempt delay 10         //修改抢占延时为10s，默认抢占延时为30s
